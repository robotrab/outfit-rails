<% content_for(:head) do %>
  <%= stylesheet_link_tag "jquery.Jcrop.min" %>
<% end %>

<%= form_for @post, :html => { :multipart => true } do |f| %>
  <%= f.file_field :outfit, onchange: "PreviewImage();", id: 'uploadImage' %>
  <%= image_tag "", id: "uploadPreview", width: "500" %>
  <%= f.text_area :message %>
  <% for attribute in [:crop_x, :crop_y, :crop_w, :crop_h] %>
    <%= f.hidden_field attribute, id: attribute %>
  <% end %>
  <%= f.submit "Post!" %>
<% end %>

<% content_for(:footer) do %>
  <%= javascript_include_tag "jquery.Jcrop.min" %>
  <script type="text/javascript">
    $(function() {
      $('#uploadPreview').load(function(){
        $(this).Jcrop({
          onChange: update_crop,
          onSelect: update_crop
        });
      });
    });

    function update_crop(coords) {
      var img = $('#uploadPreview');
      var ratio = img[0].naturalWidth / img.width();
      $('#crop_x').val(Math.round(coords.x * ratio));
      $('#crop_y').val(Math.round(coords.y * ratio));
      $('#crop_w').val(Math.round(coords.w * ratio));
      $('#crop_h').val(Math.round(coords.h * ratio));
    }
  </script>
<% end %>
